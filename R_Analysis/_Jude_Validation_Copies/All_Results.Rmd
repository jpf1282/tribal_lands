---
title: "All Results"
author: "Jude Bayham"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)

```

# Setup
Install these packages if neccessary.
```{r project_setup, message = FALSE, warning = FALSE, include=FALSE}

library(readr)
library(gamlss)
library(tidyr)
library(knitr)
library(DT)
library(dplyr)
library(purrr)
library(stringr)
library(scales)
library(broom)
library(ggplot2)
library(ggbeeswarm)
library(MASS)
library(pscl)
library(boot)
library(nlme)
library(cplm)
library(conflicted)
library(fixest)
library(sjPlot)
library(stargazer)
library(clubSandwich)

conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")

load("../final_data.Rdata")


#Function to coerce fixest object into stargazer table
fixest_to_coeftest <- function(fixest.object,ds){
  require(fixest)
  #Check if arg1 is fixest class
  if(!class(fixest.object)=="fixest"){
    stop("Not a fixest object")
  }
  
  #Extract the coefficient table
  df <- fixest.object$coeftable 
  
  if(length(fixest.object$obsRemoved)>0){
    cluster.var <- ds$tribe[-fixest.object$obsRemoved]
  } else {
    cluster.var <- ds$tribe
  }
  
  
  df.mod <- df %>%
    mutate(se = as.numeric(sqrt(diag(vcov(fixest.object,cluster=cluster.var)))),
           stat = Estimate/se,
           p = 2*pt(-abs(stat),df=nobs(fixest.object)-fixest.object$nparams)) %>%
    dplyr::select(Estimate,se,stat,p)
  
  
  #Coerce dataframe into matrix
  coeftest.object <- as.matrix(df.mod)
  
  #Capture variable names from df and rename columns to conform to coeftest
  new_names <- list(rownames(df),
                    c("Estimate","Std. Error","t value","Pr(>|t|)"))
  
  #Assign names
  dimnames(coeftest.object) <- new_names
  
  #re-class to coeftest
  class(coeftest.object) <- 'coeftest'
  
  return(coeftest.object)
  
}

#Function to coerce lme object into stargazer table
lme_to_coeftest <- function(lme.object){
  require(clubSandwich)
  #Check if arg1 is fixest class
  if(!class(lme.object)=="lme"){
    stop("Not an lme object")
  }
  
  #Extract the coefficient table
  df <- coef_test(lme.object,
                  vcov = vcovCR(lme.object,
                                type="CR2"))
  
  #Coerce dataframe into matrix
  coeftest.object <- as.matrix(df[,c(1,2,3,5)])
  
  #Capture variable names from df and rename columns to conform to coeftest
  new_names <- list(rownames(df),
                    c("Estimate","Std. Error","t value","Pr(>|t|)"))
  
  #Assign names
  dimnames(coeftest.object) <- new_names
  
  #re-class to coeftest
  class(coeftest.object) <- 'coeftest'
  
  return(coeftest.object)
  
}




#Constructing datasets
data_long <- distinct(merged_data_record_all_long, tribe, time, FIPS, .keep_all = TRUE) %>%
  ungroup() %>%
  mutate(tribe = factor(tribe),
         time = factor(time)) 

data_t1and2_long <- filter(data_long, tribe %in% tribes_time1and2_lst$tribe)

#Constructing weights
data_long <- data_long %>%
  group_by(tribe,time) %>%
  summarise(wgt=1/n()) %>%
  ungroup() %>%
  left_join(data_long,
            .,
            by=c("tribe","time"))

data_t1and2_long <- data_t1and2_long %>%
  group_by(tribe,time) %>%
  summarise(wgt=1/n()) %>%
  ungroup() %>%
  left_join(data_t1and2_long,
            .,
            by=c("tribe","time"))
  
```



The objective of this supplement is to provide detail on the analysis of CCE characteristics in the historical and present-day time periods.  We begin by detailing the methods used to compare the CCEs across time followed by an investigation of the climate, mineral access, and proximity to federal lands.



# Methods

Overview of technical details of dataset construction.... 


We employ several statistical methods to test whether characteristics of the historical lands differ from the present-day lands.  We focus on land characteristics that are either durable over long time periods or not directly impacted by the human inhabitants of the land.  We divide the characteristics into categories: climate, mineral resource access, and national lands. The set of climate characteristics consist of number of days the temperature exceeds 100 degrees Farenheit, the Palmer Drought Severity Index (PDSI) over ???, annual precipitation over ???, and a measure of wildfire hazard potential.  The set of mineral resource access characteristics include an indicator for whether a CCE lies over an oil or gas basin, the annual quantity of oil production, the annual quantity of natural gas production, and the number of oil and gas wells in a CCE.  Finally, we assess the proximity of historical and present-day CCEs to federal lands.

Our primary method to compare the historical and present-day CCEs is a linear regression of the characteristic as a function of a binary indicator for present-day lands (and an intercept), which amounts to simple ANOVA test of whether the means are equal in the historical and present-day CCEs.  All statistical tests are conducted using cluster-robust standard errors which account for heteroskedasticity and serial correlation that may exist within a tribe due to the proximity of CCEs within a tribe's range.

We assess the robustness of our estimate using alternative model specifications based on the statistical properties of the variable being analyzed.  We estimate a weighted regression model that effectively places equal weight on each tribe given the number of CCEs varies with the historical range of the tribe.  Larger, more dominant, or tribes with CCEs in the Eastern US tend to include more CCEs, which effectively increases the weight on those tribes in a simple regression setting.  We also estimate the models with tribe fixed-effects and random-effects to account for potential trends common across historical and present-day lands within a tribe. 




# CCEs Inhabited

We evaluate the spatial extent of tribes during the historical period and compare it to the present-day extent.  We estimate the difference between the number of CCEs reported as historical lands and the number of CCEs reported as present-day lands using linear regression .


```{r CCE, message = FALSE, warning = FALSE, echo = FALSE, results='asis'}
model.shell <- vector("list",5)
dep.var <- "n_unique_FIPS"

model.shell[[1]] <- feols(formula(str_c(dep.var, " ~ time")),
                          data = data_t1and2_long) %>%
  fixest_to_coeftest(.,data_t1and2_long)
                          
model.shell[[2]] <- feols(formula(str_c(dep.var, " ~ time")),
                          data = data_t1and2_long,
                          weights = ~ wgt) %>%
  fixest_to_coeftest(.,data_t1and2_long)

model.shell[[3]] <- feols(formula(str_c(dep.var, " ~ time")),
                          data = data_long) %>%
  fixest_to_coeftest(.,data_long)
                          
model.shell[[4]] <- feols(formula(str_c(dep.var, " ~ time")),
                          data = data_long,
                          weights = ~ wgt) %>%
  fixest_to_coeftest(.,data_long)

model.shell[[5]] <- feglm(formula(str_c(dep.var, " ~ time")),
                          data = data_t1and2_long,
                          family = "poisson") %>%
  fixest_to_coeftest(.,data_t1and2_long)

rownames(model.shell[[1]])

model.shell <- map(model.shell,function(x){
  rownames(x) <- c("(Intercept)","Present-Day Change")
  return(x)
})

stargazer(model.shell,type="text",
          ci=T,
          intercept.top = T,
          intercept.bottom = F,
          column.labels = c("OLS","Weighted OLS","OLS","Weighted OLS","Poisson"),
          model.numbers = T,
          add.lines = list(c("Obs","8,165","8,165","10,528","10,528","8,165")))
```



# Changes in Historical and Present-Day CCE Characteristics  



## Climate Variables

We analyze the difference between climate variables in the pre-migration lands to the post-migration lands.  We focus on heat index, drought, annual precipitation, and wildfire hazard potential.

### Heat

We begin with the heat index, which counts the number of days per year expected to exceed 100 F.  The following figures display the distribution of days exceeding 100 F in the pre-migration (time 1) and the post-migration (time 2).   
```{r, message = FALSE, warning = FALSE, echo = FALSE}


ggplot(data_long, aes(time, h_100_hist, colour = time)) +
  geom_boxplot() +
  geom_quasirandom(alpha = 1/10, varwidth = TRUE) +
  theme_minimal()


ggplot(data_t1and2_long, aes(time, h_100_hist, colour = time)) +
  geom_boxplot() +
  geom_quasirandom(alpha = 1/10, varwidth = TRUE) +
  theme_minimal()

```

We employ a battery of statistical methods to assess the difference between the number of heat days across the historical (time 1) and the present (time 2) CCEs.  The first column of Table S1 presents the results of an OLS regression of heat day CCEs on a dummy indicating present-day areas.  

The present-day and historical ranges of tribes vary within the dataset.  Tribes with larger ranges therefore have more weight in a statistical analysis of the data.  We test the robustness of our analysis to tribe population and range by creating weights inversely proportional to the number of CCEs within a tribes range.  For example, if the historical area of a tribe covered 100 CCEs, then each CCE would have a weight of 1/100 in the regression.  The weighted regression in column 2 provides an estimate of the mean difference across tribes controlling for the weight of tribes that covered more CCEs.

Lastly, there may be unobserved factors specific to the tribe that influence the results.  We control for tribe-specific factors using two related approaches: 1) a linear fixed-effects model and 2) a linear random-effects model.  For each model, we estimate a weighted and unweighted regression.  Standard errors in all specifications are clustered at the tribe level and are robust to heteroskedasticity and serial correlation within a tribe.  

```{r h_100_hist, message = FALSE, warning = FALSE, echo = FALSE, results='asis'}
dep.var <- "h_100_hist"
stargazer(model.run.t1andt2(dep.var),type="html",ci=T)
```

The results indicate that the present-day locations experience 2.54 (CI: 1.98-3.10) more 100 F days than the historic locations.  We find the lowest estimate in the weighted random-effects model, 2.07 (CI: 0.31-3.83)) and the highest in the unweighted fixed-effects model, 3.31 (CI: 1.86-3.35).  These results suggest a robust increase in the number of 100 F days in present-day CCEs relative to historical CCEs.

*Is this in line with climate change?*

(2.60+5.50)/5.50=1.47%

## Drought

We use the Palmer Drought Severity Index (PDSI) to assess exposure to drought.  

```{r, message = FALSE, warning = FALSE, echo = FALSE}


ggplot(data_long, aes(time, drt_median, colour = time)) +
  geom_boxplot() +
  geom_quasirandom(alpha = 1/10, varwidth = TRUE) +
  theme_minimal()


ggplot(data_t1and2_long, aes(time, drt_median, colour = time)) +
  geom_boxplot(varwidth = T) +
  geom_quasirandom(alpha = 1/10, varwidth = TRUE) +
  scale_y_reverse(breaks = seq(-1.5,1,by=.5), labels = c("More Drought -1.5","-1.0","-0.5","0","0.5","Less Drought 1.0")) +
  scale_colour_manual(values = c('#E0E022','#ff0000'),aesthetics = c("colour", "fill")) +
  theme_minimal() +
  xlab("") +
  ylab("") +
  scale_x_discrete(labels = c("time 1" = "Historical",
                              "time 2" = "Present-day")) +
  theme(legend.position = "none") 

```


```{r drt_median, message = FALSE, warning = FALSE, echo = FALSE, results='asis'}

dep.var <- "drt_median"
stargazer::stargazer(model.run.t1andt2(dep.var),type="html",ci=T)
```

The results indicate robust evidence that present-day lands experience more drought than historical boundaries.  The mean PDSI on the historical lands ranges from 

*Side note: why each model?  OLS is simple ANOVA comparison.  FE and RE models control for any variation constant across tribe regions.  In many regression contexts, this method controls for otherwise unobservable factors that remain constant over time.  In this case, there are no other controls so the model is detrending the effect estimate for trends common in the time 1 and time 2 periods.  *

(.28+.062)/.28


## Precipitation


```{r, message = FALSE, warning = FALSE, echo = FALSE}


ggplot(data_long, aes(time, precip, colour = time)) +
  geom_boxplot() +
  geom_quasirandom(alpha = 1/10, varwidth = TRUE) +
  theme_minimal()


ggplot(data_t1and2_long, aes(time, precip, colour = time)) +
  geom_boxplot() +
  geom_quasirandom(alpha = 1/10, varwidth = TRUE) +
  theme_minimal()

```


```{r precip, message = FALSE, warning = FALSE, echo = FALSE, results='asis'}

dep.var <- "precip"
stargazer::stargazer(model.run.t1andt2(dep.var),type="html",ci=T)
```




## Wildfire Hazard Potential

We use CCE median rather than mean to reduce the influence of outliers.

```{r, message = FALSE, warning = FALSE, echo = FALSE}


ggplot(data_long, aes(time, fire_mean, colour = time)) +
  geom_boxplot() +
  geom_quasirandom(alpha = 1/10, varwidth = TRUE) +
  theme_minimal()


ggplot(data_t1and2_long, aes(time, fire_mean, colour = time)) +
  geom_boxplot() +
  geom_quasirandom(alpha = 1/10, varwidth = TRUE) +
  scale_colour_manual(values = c('#32CD32','#ff0000'),aesthetics = c("colour", "fill")) +
  theme_minimal() +
  xlab("") +
  ylab("") +
  scale_x_discrete(labels = c("time 1" = "Historical",
                              "time 2" = "Present-day")) +
  theme(legend.position = "none") 
  

```
Figure caption: Wildfire hazard potential in historical and present-day CCEs.  While indigenous people were concentrated on fewer total CCEs (width of distribution), the mean WHP is higher in the present-day CCEs than the historical.

```{r fire_median, message = FALSE, warning = FALSE, echo = FALSE, results='asis'}

dep.var <- "fire_mean"
stargazer::stargazer(model.run.t1andt2(dep.var),type="html",ci=T)
```


(0.55 + 1.17)/1.17

Mixed evidence

# Oil and Gas


## Oil

Oil production

The distributions are highly skewed.

```{r oil_avg, message = FALSE, warning = FALSE, echo = FALSE, results='asis'}

dep.var <- "oil_avg"
stargazer::stargazer(model.run.t1andt2(dep.var),type="html",ci=T)
```

## Gas

Gas production



```{r gas_avg, message = FALSE, warning = FALSE, echo = FALSE, results='asis'}

dep.var <- "gas_avg"
stargazer::stargazer(model.run.t1andt2(dep.var),type="html",ci=T)
```

(4,294,304 + 6,083,833)/6,083,833

## Oil and Gas Basins

*I should add logit here to show robust to specification*



```{r og_basin, message = FALSE, warning = FALSE, echo = FALSE, results='asis'}

dep.var <- "og_basin"
stargazer::stargazer(model.run.t1andt2(dep.var),type="html",ci=T)
```

## Oil and Gas Wells



```{r og_well_count, message = FALSE, warning = FALSE, echo = FALSE, results='asis'}

dep.var <- "og_well_count"
stargazer::stargazer(model.run.t1andt2(dep.var),type="html",ci=T)
```




# Federal Lands


```{r, message = FALSE, warning = FALSE, echo = FALSE}


ggplot(data_long, aes(time, p_all, colour = time)) +
  geom_boxplot() +
  geom_quasirandom(alpha = 1/10, varwidth = TRUE) +
  theme_minimal()


ggplot(data_t1and2_long, aes(time, p_all, colour = time)) +
  geom_boxplot() +
  geom_quasirandom(alpha = 1/10, varwidth = TRUE) +
  theme_minimal()

```


```{r p_all, message = FALSE, warning = FALSE, echo = FALSE}

bezi_data <- mutate(data_t1and2_long, 
                    p_all = ifelse(p_all >= 1, .99999, p_all)) %>%
  filter(!is.na(p_all)) %>%
  dplyr::select(time, tribe, p_all,wgt)

bezi_model <- gamlss(p_all ~ time, family = BEZI, data = bezi_data, trace = F)

bezi_model_w <-  gamlss(p_all ~ time, family = BEZI, data = bezi_data, trace = F,weights = wgt)

tab_model(bezi_model,bezi_model_w)

t2.se <- sqrt(diag(gamlss_clustered_vcov(bezi_model,cluster = bezi_data$tribe)))
t2.se.w <- sqrt(diag(gamlss_clustered_vcov(bezi_model_w,cluster = bezi_data$tribe)))

t2.ci <- exp(c(coef(bezi_model)[2] - 1.96*t2.se[2],coef(bezi_model)[2] + 1.96*t2.se[2]))
t2.ci.w <- exp(c(coef(bezi_model_w)[2] - 1.96*t2.se.w[2],coef(bezi_model_w)[2] + 1.96*t2.se.w[2]))

```
